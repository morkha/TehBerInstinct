name: Build Connect IQ (Instinct 2X Solar + others)

on:
  push:
    paths:
      - 'source/**'
      - 'manifest.xml'
      - 'resources/**'
      - 'developer_key.der'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OUTPUT_BASENAME: TehBerInstinct
      SDK_DIR: ${{ github.workspace }}/.Garmin  # مسیر SDK موجود در repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl openssl

      - name: Verify SDK directory
        run: |
          if [ ! -d "$SDK_DIR/bin" ]; then
            echo "SDK directory not found at $SDK_DIR"
            exit 1
          fi
          echo "SDK directory found: $SDK_DIR"
          ls -la "$SDK_DIR/bin"

      - name: Prepare developer key
        run: |
          if [ -n "${{ secrets.DEVELOPER_KEY }}" ]; then
            echo "Decoding developer key from secret..."
            echo "${{ secrets.DEVELOPER_KEY }}" | base64 --decode > developer_key.pem
            chmod 600 developer_key.pem
          elif [ -f developer_key.der ]; then
            echo "Converting developer_key.der -> developer_key.pem"
            if openssl rsa -inform DER -in developer_key.der -out developer_key.pem 2>/dev/null; then
              echo "Converted with openssl rsa"
            else
              openssl pkcs8 -inform DER -in developer_key.der -nocrypt -out developer_key.pem
              echo "Converted with openssl pkcs8"
            fi
            chmod 600 developer_key.pem
          else
            echo "No developer key found. Add developer_key.der to the repo (not recommended) or set DEVELOPER_KEY secret (base64 of PEM)."
            exit 1
          fi

      - name: Ensure resources folder name
        run: |
          if [ -d recources ] && [ ! -d resources ]; then
            mv recources resources || true
          fi

      - name: Build with monkeyc (multi-device via manifest)
        run: |
          SDK_BIN="$SDK_DIR/bin/monkeyc"
          chmod +x "$SDK_BIN"
          mkdir -p build
          OUTNAME="${OUTPUT_BASENAME}.iq"
          echo "Output file: build/$OUTNAME"
          "$SDK_BIN" \
            -o "build/$OUTNAME" \
            -m manifest.xml \
            -y developer_key.pem \
            -z "$SDK_DIR" \
            -f source/*.mc

      - name: List build output
        run: |
          ls -la build || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: connectiq-build
          path: build/

      - name: Security reminder
        if: always()
        run: |
          echo "If developer key was committed to the repository, please remove it and rotate the key. Use repository secrets instead."
