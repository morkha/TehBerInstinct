name: Build Connect IQ (Multi-device, no separate XML)

on:
  push:
    paths:
      - 'source/**'
      - 'manifest.xml'
      - 'resources/**'
      - 'developer_key.der'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OUTPUT_BASENAME: TehBerInstinct
      SDK_MANAGER_URL: https://developer.garmin.com/downloads/connect-iq/sdk-manager/connectiq-sdk-manager-linux.zip
      SDK_DIR: ${{ github.workspace }}/.GarminSDK  # مسیر نصب SDK در workspace

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl openssl

      - name: Download and extract Connect IQ SDK Manager
        run: |
          echo "Downloading SDK Manager..."
          curl -fL "$SDK_MANAGER_URL" -o sdkmanager.zip
          unzip -q sdkmanager.zip -d sdkmanager || true
          echo "SDK Manager downloaded and extracted."

      - name: Install Connect IQ SDK
        run: |
          # اگر SDK قبلا نصب نشده، نصب کن
          if [ ! -d "$SDK_DIR" ]; then
            mkdir -p "$SDK_DIR"
            # SDK Manager معمولا داخل sdkmanager/connectiq-sdk-* هست
            SDK_ARCHIVE=$(find sdkmanager -type f -iname 'connectiq-sdk-*-linux-x64.tar.gz' -print -quit || true)
            if [ -f "$SDK_ARCHIVE" ]; then
              tar -xzf "$SDK_ARCHIVE" -C "$SDK_DIR" --strip-components=1
              echo "SDK extracted to $SDK_DIR"
            else
              echo "SDK archive not found in sdkmanager. Please ensure SDK Manager downloaded SDK."
              exit 1
            fi
          fi

      - name: Verify SDK binary
        run: |
          SDK_BIN="$SDK_DIR/bin/monkeyc"
          if [ ! -f "$SDK_BIN" ]; then
            echo "monkeyc not found at $SDK_BIN"
            exit 1
          fi
          chmod +x "$SDK_BIN"
          echo "Found monkeyc at $SDK_BIN"

      - name: Prepare developer key
        run: |
          if [ -n "${{ secrets.DEVELOPER_KEY }}" ]; then
            echo "${{ secrets.DEVELOPER_KEY }}" | base64 --decode > developer_key.pem
            chmod 600 developer_key.pem
          elif [ -f developer_key.der ]; then
            if openssl rsa -inform DER -in developer_key.der -out developer_key.pem 2>/dev/null; then
              echo "Converted developer_key.der with openssl rsa"
            else
              openssl pkcs8 -inform DER -in developer_key.der -nocrypt -out developer_key.pem
              echo "Converted developer_key.der with openssl pkcs8"
            fi
            chmod 600 developer_key.pem
          else
            echo "No developer key found. Set DEVELOPER_KEY secret or add developer_key.der"
            exit 1
          fi

      - name: Ensure resources folder name
        run: |
          if [ -d recources ] && [ ! -d resources ]; then
            mv recources resources || true
          fi

      - name: Build Connect IQ app
        run: |
          SDK_BIN="$SDK_DIR/bin/monkeyc"
          mkdir -p build
          OUTNAME="${OUTPUT_BASENAME}.iq"
          echo "Output file: build/$OUTNAME"
          "$SDK_BIN" \
            -o "build/$OUTNAME" \
            -m manifest.xml \
            -y developer_key.pem \
            -z "$SDK_DIR" \
            -f source/*.mc

      - name: List build output
        run: ls -la build || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: connectiq-build
          path: build/

      - name: Security reminder
        if: always()
        run: |
          echo "If developer key was committed to the repository, remove it and rotate the key. Use secrets instead."
